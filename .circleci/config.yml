version: 2.1
executors:
  node:
    docker:
      - image: circleci/node:lts

aliases:
  install_node_modules: &install_node_modules
    run:
      name: Install Packages
      command: npm install

  build: &build
    run:
      name: Build Gatsby Site
      command: npm run build

  deploy_gh_pages: &deploy_gh_pages
    deploy:
      name: Deploy to Github Pages
      command: |
        if [ "${CIRCLE_BRANCH}" == "source" ]; then
          echo -e "Starting to deploy to Github Pages. Working directory ${CIRCLE_WORKING_DIRECTORY}\n"
          git config --global user.email ${GIT_EMAIL}
          git config --global user.name ${GIT_NAME}
          echo albertmolodec.js.org > ./public/CNAME
          ./node_modules/.bin/gh-pages -d public -b master -r https://${GH_TOKEN}@github.com/${TARGET_REPO}
        fi

  test: &test
    run:
      name: Testing
      command: npm run test

  restore_cache: &restore_cache
    restore_cache:
      name: Restore Package Cache
      keys:
        - v1-dependencies-{{ checksum "package-lock.json" }}
        - v1-dependencies-

  save_cache: &save_cache
    save_cache:
      name: Save Package Cache
      key: v1-dependencies-{{ checksum "package-lock.json" }}
      paths:
        - node_modules

  store_results: &store_results
    store_test_results:
      path: results

  store_results_artifacts: &store_results_artifacts
    store_artifacts:
      path: results

jobs:
  build_and_deploy:
    executor: node
    working_directory: ~/website
    environment:
      TARGET_REPO: albertmolodec/albertmolodec.github.io.git
      GIT_EMAIL: 'albert.abdu@gmail.com'
      GIT_NAME: 'Альберт Абдульманов'
    steps:
      - checkout
      - <<: *restore_cache
      - <<: *install_node_modules
      - <<: *save_cache
      - <<: *build
      - <<: *deploy_gh_pages

  test:
    executor: node
    working_directory: ~/website
    steps:
      - checkout
      - <<: *test

workflows:
  version: 2
  main:
    jobs:
      - build_and_deploy:
          filters:
            branches:
              only: source
              ignore:
                - master
      - test
